import CanvasRuntimeManager from './canvasruntimemanager';
import PythonRuntime from './runtime-python';
import PythonSolutionRuntime from './runtime-solution-python';

/**
 * Test runtime for executing Python student code against reference solutions.
 *
 * Combines:
 * - PythonRuntime (language-specific execution via Skulpt)
 * - TestRuntimeMixin (test orchestration and lifecycle)
 */
export default class PythonTestRuntime extends H5P.TestRuntimeMixin(PythonRuntime) {
  /**
   * Creates a Python runtime for executing the reference solution.
   * @returns {PythonSolutionRuntime}
   */
  createSolutionRuntime() {
    return new PythonSolutionRuntime(
      this.resizeActionHandler,
      this.solutionCode,
      this.codeTester,
      this.options
    );
  }

  getCanvasManager() {
    if (!this._canvasManager) {
      this._canvasManager = new CanvasRuntimeManager(this.codeTester.view, this.runner);
      this._canvasManager.setup();
    }
    return this._canvasManager;
  }

  /**
   * Prepares the Python runtime before executing student code.
   * Sets up canvas handling if canvas-related code is detected.
   */
  prepareForRun() {
    super.prepareForRun();
    if (this.containsCanvasCode(this.getCode())) {
      this.getCanvasManager().attachCanvas('testcase', this.codeTester.testCaseIndex);
    }
  }

  /**
   * Removes all canvases created for test cases.
   */
  reset() {
    super.reset();
    this.canvasManager?.removeCanvas();
  }

  /**
   * Handles output generated by the Python runtime.
   * Stores output in the CodeTester and writes it to the test console.
   * @param {string} text - Output text
   */
  outputHandler(text) {
    const trimmedText = text.trim();
    this.codeTester.addOutput(trimmedText);

    const testCaseIndex = this.codeTester.session.testCaseIndex;
    this._consoleManager.write(text, `Test ${testCaseIndex + 1}`);
  }

  /**
   * Sets up the runtime for test execution.
   * Initializes console and canvas managers and marks the runtime as test mode.
   * @param {object} codeContainer - Container holding code and output elements
   */
  setup(codeContainer) {
    super.setup(codeContainer);

    this._consoleManager ||= this.createConsoleManager();
    this._canvasManager ||= this.createCanvasManager();
    this.isTest = true;
  }
}
